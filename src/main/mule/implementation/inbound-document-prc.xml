<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:crypto="http://www.mulesoft.org/schema/mule/crypto" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:x12="http://www.mulesoft.org/schema/mule/x12"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/x12 http://www.mulesoft.org/schema/mule/x12/current/mule-x12.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/crypto http://www.mulesoft.org/schema/mule/crypto/current/mule-crypto.xsd">
	<sub-flow name="edi-document-processing-sub-flow" doc:id="c386ba24-eecd-4f96-86ed-61f6609d23e8" >
		<logger level="INFO" doc:name="START" doc:id="4b8451b4-f771-48b3-b357-4f08848cd103" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;    flow : "Start of flow : " ++ flow.name,&#10;    message: "Flow for EDI document processing",&#10;    correlationId: correlationId&#10;}]'/>
		<ee:transform doc:name="var : transactionType &amp; customerName" doc:id="f4e32ebd-0091-494e-a23f-6cec18d7afe6">
			<ee:variables>
				<ee:set-variable variableName="customerName"><![CDATA[attributes.uriParams.'customerName']]></ee:set-variable>
				<ee:set-variable variableName="transactionType"><![CDATA[attributes.uriParams.'transactionType']]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<crypto:pgp-decrypt doc:name="payload" doc:id="0b89cf4d-444c-4e3a-a28a-849102356958" config-ref="crypto-pgp"/>
		<ee:transform doc:name="Appending headers (ISA &amp; GE)" doc:id="c79071e1-cc0e-43e1-b048-b7d001db535b" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output text/plain
---
if (vars.transactionType ~= '850')
"ISA*00*          *00*          *ZZ*SENDER         *ZZ*RECEIVER       *240216*0633*U*00401*000000001*0*T*>~
GS*PO*SENDERGS*RECEIVERGS*20240216*063328*000000001*X*004010~" 
++ payload ++ 
"GE*1*000000001~
IEA*1*000000001~"
else
"Unsupported Transaction Type"]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<x12:read doc:name="Validate EDI" doc:id="832acbe2-6c37-4046-82a2-4d0dd23f5ee6" config-ref="X12_EDI_Config_read"/>
		<ee:transform doc:name="var : dwlFilePath, recordType, operation" doc:id="530e9cde-c5c9-40ea-b254-80945b9d7668" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="dwlFilePath" ><![CDATA[%dw 2.0
output application/java
var dwlFilePath = 'classpath://dwl/' ++ vars.transactionType ++ "-" ++ vars.customerName ++ '.dwl'
---
readUrl(dwlFilePath, 'text/plain')]]></ee:set-variable>
				<ee:set-variable variableName="recordType" ><![CDATA[%dw 2.0
output application/java
---
if (vars.transactionType ~= '850') "salesOrder"
else "Unsupported Record Type"


//(payload.TransactionSets.v004010 pluck $$) contains ('850' as Key)]]></ee:set-variable>
				<ee:set-variable variableName="operation" ><![CDATA[%dw 2.0
output application/java
---
"add"]]></ee:set-variable>
			</ee:variables>
		
</ee:transform>
		<ee:dynamic-evaluate doc:name="NetSuite Payload" doc:id="fdb152d2-bbae-4830-a990-8f4790ed32ba" expression="#[vars.dwlFilePath]">
			<ee:parameters >#[{payload : payload}]</ee:parameters>
		</ee:dynamic-evaluate>
		<ee:transform doc:name="Overriding Payload" doc:id="3443bdfc-f102-4063-80bf-1a0223a9c35c">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
import * from dw::core::Strings
fun makeItUnique (commonKeys) = (commonKeys mapObject ((value, key, index) -> ("$(ordinalize(index+1)) $(key)"): value))
output application/json
---
payload[0]  update {
    case customFields at .customFieldList -> makeItUnique(customFields)
    case customFieldsLine at .itemList.item.item.customFieldList -> makeItUnique(customFieldsLine)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="POST : /transaction" doc:id="d176151f-e814-4017-993a-ad5257c21dd0" sendCorrelationId="ALWAYS" config-ref="mc-exp-api-request-config" path="${sys.path}" outputMimeType="application/json">
			<http:headers ><![CDATA[#[output application/java
---
{
	recordType : vars.recordType,
	operation : vars.operation
}]]]></http:headers>
		</http:request>
		<logger level="INFO" doc:name="END" doc:id="e27f320b-bd31-49ac-bfd6-f6303cd0cabd" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;    flow : "End of flow : " ++ flow.name,&#10;    message: "Flow for EDI document processing Ended",&#10;    correlationId: correlationId&#10;}]'/>
	
</sub-flow>
</mule>
